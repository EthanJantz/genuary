class S{constructor(p,x,y,r,n,c){this.p=p;this.cd=0;this.pos=p.createVector(x,y);this.rs=p.map(p.random(),0,1,0,1e6);this.ro=p.map(p.random(),0,1,0,1e6);this.vel=p.createVector(20*p.noise(.005*p.frameCount+this.rs),20*p.noise(.005*p.frameCount+this.rs+this.ro));this.r=r;this.n=n;this.c=c;this.ms=5;this.mf=.05;this.pr=50}flock(a){let{p,pos,vel,pr}=this,sep=p.createVector(0,0),ali=p.createVector(0,0),t=0;for(let o of a){if(o===this)continue;let d=pos.dist(o.pos);if(d<pr){let df=p5.Vector.sub(pos,o.pos);df.div(d*d);sep.add(df);ali.add(o.vel);t++}}if(t>0){sep.div(t);sep.setMag(this.ms);sep.sub(vel);sep.limit(this.mf);ali.div(t);ali.setMag(this.ms);ali.sub(vel);ali.limit(this.mf)}let sk=p.createVector(0,0);if(this.tg){let ds=p5.Vector.sub(this.tg,pos);ds.setMag(this.ms);sk.add(p5.Vector.sub(ds,vel));sk.limit(this.mf)}sep.mult(p.map(this.n,3,10,1.5,.2));this.vel.add(sep);this.vel.add(ali);this.vel.add(sk);this.vel.limit(this.ms)}split(){return this.n>16}update(a){let{p,pos,r}=this;if(this.cd>0)this.cd--;if(p.frameCount%60===0&&p.random()<.1)this.n++;this.ms=3+this.n*.5;this.flock(a);pos.add(this.vel);let b=3;if(pos.x>p.width-r){this.pos.x=r;this.vel.x=Math.abs(this.vel.x)+b}if(pos.x<r){this.pos.x=p.width-r;this.vel.x=-Math.abs(this.vel.x)-b}if(pos.y>p.height-r){this.pos.y=r;this.vel.y=Math.abs(this.vel.y)+b}if(pos.y<r){this.pos.y=p.height-r;this.vel.y=-Math.abs(this.vel.y)-b}}draw(){let{p,pos,r,n,c}=this,{x,y}=pos;p.fill(c);p.beginShape();for(let i=0;i<n;i++){let a=p.map(i,0,n,0,p.TWO_PI)-p.HALF_PI;p.vertex(x+p.cos(a)*r,y+p.sin(a)*r)}p.endShape(p.CLOSE)}hit(o){return this.pos.dist(o.pos)<this.r+o.r}}
function gM(a){let c={};for(let s of a)c[s.n]=(c[s.n]||0)+1;let m=3,mx=0;for(let[n,ct]of Object.entries(c))if(ct>mx){mx=ct;m=parseInt(n)}return m}
function gF(p,n,ct,r){let pts=[],cx=p.width/2,cy=p.height/2,pe=Math.ceil(ct/n);for(let i=0;i<n;i++){let a1=p.map(i,0,n,0,p.TWO_PI)-p.HALF_PI,a2=p.map(i+1,0,n,0,p.TWO_PI)-p.HALF_PI,x1=cx+p.cos(a1)*r,y1=cy+p.sin(a1)*r,x2=cx+p.cos(a2)*r,y2=cy+p.sin(a2)*r;for(let j=0;j<pe;j++){let t=j/pe;pts.push(p.createVector(p.lerp(x1,x2,t),p.lerp(y1,y2,t)))}}return pts}
function aT(a,pts){let av=[...pts];for(let s of a){if(!av.length)break;let ni=0,nd=Infinity;for(let i=0;i<av.length;i++){let d=s.pos.dist(av[i]);if(d<nd){nd=d;ni=i}}s.tg=av[ni];av.splice(ni,1)}}
let sh,lc=0,mS=3,smS=3,aS=3;p=new P5();sh=[];for(let i=0;i<50;i++)sh.push(new S(p,p.random(p.width),p.random(p.height),p.random(10,20),p.floor(p.random(3,5)),p.color(255,255,255)));
p.draw=()=>{p.background(0);let sc=sh.length!==lc;lc=sh.length;mS=gM(sh);smS=p.lerp(smS,mS,.05);let ts=sh.reduce((s,x)=>s+x.n,0);aS=Math.round(ts/sh.length)||3;let rd=Math.min(p.width,p.height)*.4;if(p.frameCount%30===0||sc){let pts=gF(p,aS,sh.length,rd);aT(sh,pts)}let rm=new Set(),ad=new Set();sh.forEach((s,i)=>{if(rm.has(s))return;s.update(sh);sh.slice(i+1).forEach(o=>{if(s.hit(o)){if(s.cd>0||o.cd>0||rm.has(o))return;let m=s.n>=o.n?s:o,l=s.n<o.n?s:o,c1=p.color(m.c),c2=p.color(l.c);rm.add(l);m.n+=l.n;m.c=p.lerpColor(c1,c2,.5);if(m.split()){rm.add(m);let of=m.r*1.5,s1=new S(p,m.pos.x-of,m.pos.y-of,Math.max(m.r/2,7),3,p.lerpColor(c1,c2,.5)),s2=new S(p,l.pos.x+of,l.pos.y+of,Math.max(l.r/2,7),3,p.lerpColor(c1,c2,.5));s1.cd=10;s2.cd=10;ad.add(s1).add(s2)}}});s.draw()});sh.push(...ad);sh=sh.filter(s=>!rm.has(s));if(sh.length<40){let ns=new S(p,p.random(p.width),p.random(p.height),p.random(10,20),p.floor(p.random(6,11)),p.color(255,255,255));ns.cd=10;sh.push(ns)}if(p.frameCount%300===0){let bt=p.random()<.5?'h':'l',bc=p.floor(p.random(8,15));for(let i=0;i<bc;i++){let ns=new S(p,p.random(p.width),p.random(p.height),p.random(10,20),bt==='h'?p.floor(p.random(6,9)):3,p.color(255,255,255));ns.cd=10;sh.push(ns)}}};
s0.init({src:p.canvas});solid(()=>(Math.sin(aS*.3)+1)/2,()=>(Math.sin(aS*.3+1)+1)/2,()=>(Math.sin(aS*.3+2)+1)/2).out(o2);src(o2).diff(src(s0)).out(o0);src(o2).mult(shape(()=>aS,.5,.01).invert().rotate(Math.PI)).add(shape(()=>aS,.5,.01).rotate(Math.PI)).out(o1);src(o0).blend(src(o1),.5).out(o3);render(o3);
