class Particle{constructor(p,x,y){this.p=p;this.pos=p.createVector(x,y);this.vel=p.createVector(p.random(-10,10),p.random(-10,10));this.trail=[];this.nextIsDash=true;this.fadeDuration=5000;this.dashLength=5;this.gapLength=5;this.radius=10;this.acc=p.createVector(0,0)}applyForce(f){this.acc.add(f)}collideWith(o){const d=this.pos.dist(o.pos),m=this.radius+o.radius;if(d<m&&d>0){const n=p5.Vector.sub(o.pos,this.pos).normalize(),r=p5.Vector.sub(this.vel,o.vel),v=r.dot(n);if(v>0){const i=n.copy().mult(v);this.vel.sub(i);o.vel.add(i);const ol=m-d,s=n.copy().mult(ol/2);this.pos.sub(s);o.pos.add(s);collisionCount++}}}update(){const s=this.vel.mag(),dl=this.p.map(s,0,5,2,20),md=dl+this.gapLength,l=this.trail[this.trail.length-1];if(!l||this.p.dist(this.pos.x,this.pos.y,l.x,l.y)>=md){this.trail.push({x:this.pos.x,y:this.pos.y,time:this.p.millis(),isDash:this.nextIsDash});this.nextIsDash=!this.nextIsDash}const now=this.p.millis();this.trail=this.trail.filter(pt=>now-pt.time<this.fadeDuration);this.vel.add(this.acc);this.acc.mult(0);this.pos.add(this.vel);this.vel.mult(0.99);if(this.pos.x<0||this.pos.x>this.p.width){this.vel.x*=-1.2;this.vel.y+=this.p.random(-0.2,0.2)}if(this.pos.y<0||this.pos.y>this.p.height){this.vel.y*=-1.2;this.vel.x+=this.p.random(-0.2,0.2)}}display(){const now=this.p.millis();this.p.strokeWeight(2);this.p.noFill();for(let i=1;i<this.trail.length;i++){const p1=this.trail[i-1],p2=this.trail[i];if(!p1.isDash)continue;const age=now-p1.time,alpha=this.p.map(age,0,this.fadeDuration,255,0);this.p.stroke(0,alpha);this.p.line(p1.x,p1.y,p2.x,p2.y)}this.p.noStroke();this.p.ellipse(this.pos.x,this.pos.y,this.radius*2,this.radius*2)}}
let particles=[],gravity,avgAngle=0,avgDist=0,collisionCount=0;const numParticles=50,gravityStrength=0.2;p=new P5();gravity=p.createVector(0,0);for(let i=0;i<numParticles;i++)particles.push(new Particle(p,p.random(p.width),p.random(p.height)));
p.draw=()=>{p.background(220);collisionCount=0;const center=p.createVector(p.width/2,p.height/2),mouse=p.createVector(p.mouseX,p.mouseY),tilt=p5.Vector.sub(mouse,center),maxDist=p.mag(p.width/2,p.height/2),tiltAmount=tilt.mag()/maxDist;gravity=tilt.normalize().mult(gravityStrength*tiltAmount);for(let i=0;i<particles.length;i++)for(let j=i+1;j<particles.length;j++)particles[i].collideWith(particles[j]);for(const pt of particles){pt.applyForce(gravity);pt.update();pt.display()}let sumX=0,sumY=0,sumDist=0;for(const pt of particles){const angle=p.atan2(pt.pos.y-center.y,pt.pos.x-center.x);sumX+=p.cos(angle);sumY+=p.sin(angle);sumDist+=center.dist(pt.pos)}avgAngle=p.atan2(sumY,sumX);avgDist=sumDist/particles.length/maxDist};
s0.init({src:p.canvas});noise(()=>avgDist*10).kaleid(360).diff(src(o1)).out(o0);src(s0).diff(solid(255,255,0)).rotate(()=>avgAngle).invert().blend(src(o1).scale(1.01),()=>avgDist*0.9).out(o1);render(o0);
